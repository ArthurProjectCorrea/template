name: ğŸ“š Auto-Update Wiki

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/src/**'
      - 'apps/web/app/**'
      - 'apps/web/components/**'
      - 'packages/ui/src/**'
      - '.github/workflows/**'
      - 'README.md'
      - 'docs/**'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all wiki pages'
        required: false
        default: 'false'

  # Schedule daily updates
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM UTC

concurrency:
  group: wiki-update
  cancel-in-progress: false

jobs:
  update-wiki:
    name: Update Wiki Documentation
    runs-on: ubuntu-latest
    if: github.repository_owner == github.actor || github.event_name == 'schedule'
    
    permissions:
      contents: write
      
    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: false

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“š Generate Wiki Content
        run: |
          echo "ğŸš€ Starting wiki generation..."
          node scripts/generate-wiki.js
          echo "âœ… Wiki generation completed"

      - name: ğŸ” Check for Changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain .github/wiki)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Wiki changes detected"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ No wiki changes detected"
          fi

      - name: ğŸ“Š Wiki Update Summary
        if: steps.changes.outputs.changes == 'true'
        run: |
          echo "ğŸ“š Wiki Update Summary:"
          echo "===================="
          git status --porcelain .github/wiki | while read status file; do
            case $status in
              "A ") echo "â• Added: $(basename "$file")" ;;
              "M ") echo "ğŸ“ Modified: $(basename "$file")" ;;
              "D ") echo "ğŸ—‘ï¸ Deleted: $(basename "$file")" ;;
              "??") echo "ğŸ†• New: $(basename "$file")" ;;
              *) echo "ğŸ”„ Changed: $(basename "$file")" ;;
            esac
          done

      - name: ğŸ“¤ Commit Wiki Changes
        if: steps.changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .github/wiki
          git commit -m "docs: auto-update wiki documentation

          ğŸ“š Automated wiki update by documentation-helper
          ğŸ¤– Generated on $(date -u +%Y-%m-%dT%H:%M:%SZ)
          ğŸ“‹ Updated documentation for API, components, workflows
          
          [skip ci]"
          
          git push

      - name: ğŸ“¢ Wiki Update Notification
        if: steps.changes.outputs.changes == 'true'
        run: |
          echo "âœ… Wiki successfully updated!"
          echo "ğŸ“– View updated documentation in .github/wiki/"

      - name: ğŸ“‹ No Changes Notification
        if: steps.changes.outputs.changes == 'false'
        run: |
          echo "ğŸ“‹ No wiki updates needed"
          echo "ğŸ“š All documentation is up to date"
